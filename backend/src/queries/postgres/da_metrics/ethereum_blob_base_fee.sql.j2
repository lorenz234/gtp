{#
    A query to add blob_base_fee, target_blob_gas and blob_base_fee_update_fraction to ethereum_blocks table.
#}

{% set from_block = from_block %}
{% set to_block = to_block %}

WITH BlockCalculations AS (
    SELECT
        t.number,
        t.excess_blob_gas,
        
        -- 1. Calculate Target Blob Gas (Value to be updated)
        CASE
            WHEN t.number >= 23975778 THEN 10 * 128 * 1024 -- BPO1 Fusaka (10 blobs)
            WHEN t.number >= 22431084 THEN 6 * 128 * 1024  -- Pectra & Fusaka (6 blobs)
            ELSE 3 * 128 * 1024                           -- Dencun (3 blobs of 128kib)
        END AS calculated_target_blob_gas,
        
        -- 2. Calculate Blob Base Fee Update Fraction (Value to be updated, also reused in next step)
        CASE
            WHEN t.number >= 23975778 THEN 8346193 -- BPO1 Fusaka
            WHEN t.number >= 22431084 THEN 5007716 -- Pectra & Fusaka
            ELSE 3338477                           -- Dencun
        END AS calculated_blob_base_fee_update_fraction
        
    FROM 
        public.ethereum_blocks AS t
    WHERE 
        t.number BETWEEN {{from_block}} AND {{to_block}} -- Restrict to the required range
)
UPDATE public.ethereum_blocks AS t_update
SET
    target_blob_gas = c.calculated_target_blob_gas,
    blob_base_fee_update_fraction = c.calculated_blob_base_fee_update_fraction,
    blob_base_fee = 
        -- Calculate the base fee (in Wei) using the exponential formula and TRUNCATION (cut-off)
        (
            CAST(
                TRUNC( -- Applying TRUNC() as requested by the final SELECT query
                    EXP(
                        CAST(c.excess_blob_gas AS NUMERIC) / 
                        CAST(c.calculated_blob_base_fee_update_fraction AS NUMERIC)
                    )
                )
            AS BIGINT)
        )
FROM 
    BlockCalculations AS c
WHERE 
    t_update.number = c.number;