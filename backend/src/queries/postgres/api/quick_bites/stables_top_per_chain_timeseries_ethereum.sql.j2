{#
    A query to get top stablecoins for ethereum based on last day's data,
    then show their full timeseries plus a longtail 'other' category.
#}

WITH base_data AS (
    -- Get supply metrics for ethereum
    SELECT
        "date",
        metric_key,
        token_key,
        fiat,
        value,
        value_usd
    FROM public.vw_fact_stables_usd
    WHERE origin_key = 'ethereum'
),
bridged_data AS (
    -- Get bridged supply from all other origins
    SELECT
        "date",
        metric_key,
        token_key,
        fiat,
        value,
        value_usd
    FROM public.vw_fact_stables_usd
    WHERE metric_key = 'supply_bridged'
),
combined_data AS (
    -- Combine both datasets
    SELECT * FROM base_data
    UNION ALL
    SELECT * FROM bridged_data
),
adjusted_values AS (
    -- Apply adjustments: supply_locked is already negative, subtract bridged from supply
    SELECT
        "date",
        token_key,
        fiat,
        SUM(CASE
            WHEN metric_key = 'supply_bridged' THEN -value
            ELSE value
        END) as value,
        SUM(CASE
            WHEN metric_key = 'supply_bridged' THEN -value_usd
            ELSE value_usd
        END) as value_usd
    FROM combined_data
    GROUP BY "date", token_key, fiat
),
last_day_totals AS (
    -- Step: Get the last available day and sum by token_key
    SELECT
        token_key,
        SUM(value_usd) as total_value_usd
    FROM adjusted_values
    WHERE "date" = (SELECT MAX("date") FROM adjusted_values WHERE "date" != CURRENT_DATE)
    GROUP BY token_key
),
top_tokens AS (
    -- Step: Identify the top x token_keys from the last day
    SELECT token_key
    FROM last_day_totals
    ORDER BY total_value_usd DESC
    LIMIT 6
),
top_series AS (
    -- Step: Get full timeseries for top tokens
    SELECT
        "date",
        token_key,
        fiat,
        value,
        value_usd
    FROM adjusted_values
    WHERE token_key IN (SELECT token_key FROM top_tokens)
),
longtail AS (
    -- Step: Aggregate everything else as 'other'
    SELECT
        "date",
        'other' as token_key,
        NULL as fiat,
        SUM(value) as value,
        SUM(value_usd) as value_usd
    FROM adjusted_values
    WHERE token_key NOT IN (SELECT token_key FROM top_tokens)
    GROUP BY "date"
),
combined AS (
    SELECT * FROM top_series
    UNION ALL
    SELECT * FROM longtail
)
SELECT
    c."date",
    c.value_usd,
    COALESCE(sm.symbol, 'other') as symbol
FROM combined c
LEFT JOIN public.stables_metadata sm
    ON c.token_key = sm.token_key
    AND c.fiat = sm.fiat
WHERE c."date" != CURRENT_DATE
ORDER BY c."date" DESC, c.value_usd DESC;