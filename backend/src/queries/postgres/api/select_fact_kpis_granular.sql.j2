{#
    A query to get the data from the fact_kpis_granular table

    Parameters:
    - days: default = 7; The time interval (in days) to consider for data extraction.
    - metric_key: The metric key to consider for data extraction.
    - orgin_key: The origin key to consider for data extraction.
    - granularity: granularity level (e.g., 'hourly')
#}

{% set days = days | default(7) %}
{% set granularity = granularity | default('hourly') %}

SELECT 
    fk."timestamp" as "date",
    fk.value
FROM public.fact_kpis_granular fk
WHERE fk.metric_key = '{{ metric_key }}'
    AND fk.origin_key = '{{ origin_key }}'
    AND fk.granularity = '{{ granularity }}'
    AND fk."timestamp" >= now() - INTERVAL '{{ days }} days' 
    AND fk."timestamp" < date_trunc('hour', now())
ORDER BY fk."timestamp" DESC
